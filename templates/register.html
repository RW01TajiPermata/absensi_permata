{% extends "base.html" %}

{% block title %}Daftar Akun Baru - Permata{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white text-center">
                <h4 class="mb-0"><i class="fas fa-user-plus"></i> Daftar Akun Baru</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="username" class="form-label">
                            <i class="fas fa-user"></i> Username / Nama Lengkap
                        </label>
                        <input type="text" class="form-control" id="username" name="username" 
                               placeholder="Masukkan username atau nama lengkap Anda" 
                               value="{{ request.form.username if request.form.username }}" 
                               required>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> Bisa menggunakan nama lengkap, nickname, atau username favorit (3-50 karakter)
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="nomor_telepon" class="form-label">
                            <i class="fas fa-phone"></i> Nomor Telepon
                        </label>
                        <input type="tel" class="form-control" id="nomor_telepon" name="nomor_telepon" 
                               placeholder="Contoh: 081234567890" 
                               value="{{ request.form.nomor_telepon if request.form.nomor_telepon }}">
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> Contoh: 081234567890 (10-15 digit, wajib dimulai dengan 0)
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="rt" class="form-label">
                            <i class="fas fa-home"></i> RT
                        </label>
                        <select class="form-select" id="rt" name="rt" required>
                            <option value="">-- Pilih RT --</option>
                            <option value="001" {% if request.form.rt == '001' %}selected{% endif %}>RT 01</option>
                            <option value="002" {% if request.form.rt == '002' %}selected{% endif %}>RT 02</option>
                            <option value="003" {% if request.form.rt == '003' %}selected{% endif %}>RT 03</option>
                            <option value="004" {% if request.form.rt == '004' %}selected{% endif %}>RT KOTA(+)</option>
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> Pilih RT tempat tinggal Anda
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="fas fa-lock"></i> Password
                        </label>
                        <input type="password" class="form-control" id="password" name="password" 
                               placeholder="Minimal 6 karakter" required>
                        <div class="form-text">
                            <i class="fas fa-shield-alt"></i> Password harus minimal 6 karakter untuk keamanan
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">
                            <i class="fas fa-lock"></i> Konfirmasi Password
                        </label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                               placeholder="Ulangi password yang sama" required>
                        <div class="form-text">
                            <i class="fas fa-check-circle"></i> Pastikan password sama dengan di atas
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100 btn-lg">
                        <i class="fas fa-user-plus"></i> Daftar Sekarang
                    </button>
                </form>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="mt-3">
                            {% for category, message in messages %}
                                {% if category == 'error' %}
                                    <div class="alert alert-danger alert-dismissible fade show">
                                        <i class="fas fa-exclamation-triangle"></i> {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% elif category == 'success' %}
                                    <div class="alert alert-success alert-dismissible fade show">
                                        <i class="fas fa-check-circle"></i> {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                
                <div class="mt-4 text-center">
                    <p class="mb-2">
                        <i class="fas fa-user-check"></i> Sudah punya akun? 
                        <a href="{{ url_for('login') }}" class="text-decoration-none fw-bold">Login di sini</a>
                    </p>
                    <small class="text-muted">
                        <i class="fas fa-lightbulb"></i> Contoh username yang bisa digunakan: 
                        "budi gunadi sadikin", "bahlul", "intinya nama anda lahh!!!!", 
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Client-side validation untuk user experience yang lebih baik
document.addEventListener('DOMContentLoaded', function() {
    const usernameInput = document.getElementById('username');
    const nomorTeleponInput = document.getElementById('nomor_telepon');
    const rtSelect = document.getElementById('rt');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const form = document.querySelector('form');
    
    function validateUsername(username) {
        if (username.length < 3) {
            return 'Username harus minimal 3 karakter';
        }
        if (username.length > 50) {
            return 'Username maksimal 50 karakter';
        }
        // Validasi karakter yang diizinkan: huruf, angka, spasi, titik, dash, underscore, @
        const validChars = /^[a-zA-Z0-9\s\.\-_@]+$/;
        if (!validChars.test(username)) {
            return 'Username mengandung karakter yang tidak diizinkan';
        }
        return null;
    }
    
    function validateNomorTelepon(nomorTelepon) {
        if (nomorTelepon) {
            const cleanNumber = nomorTelepon.replace(/\D/g, '');
            if (cleanNumber.length < 10 || cleanNumber.length > 15) {
                return 'Nomor telepon harus 10-15 digit';
            }
            if (!cleanNumber.startsWith('0')) {
                return 'Nomor telepon harus dimulai dengan angka 0';
            }
        }
        return null;
    }
    
    function validateRT(rt) {
        if (!rt) {
            return 'RT harus dipilih';
        }
        return null;
    }
    
    function validatePassword(password) {
        if (password.length < 6) {
            return 'Password harus minimal 6 karakter';
        }
        return null;
    }
    
    function validateConfirmPassword(password, confirmPassword) {
        if (password !== confirmPassword) {
            return 'Password dan konfirmasi password tidak cocok';
        }
        return null;
    }
    
    // Real-time validation
    usernameInput.addEventListener('blur', function() {
        const error = validateUsername(this.value);
        if (error) {
            this.classList.add('is-invalid');
            // Tampilkan pesan error
            let feedback = this.nextElementSibling;
            if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                this.parentNode.appendChild(feedback);
            }
            feedback.textContent = error;
            feedback.style.display = 'block';
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });
    
    nomorTeleponInput.addEventListener('blur', function() {
        const error = validateNomorTelepon(this.value);
        if (error) {
            this.classList.add('is-invalid');
            let feedback = this.nextElementSibling;
            if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                this.parentNode.appendChild(feedback);
            }
            feedback.textContent = error;
            feedback.style.display = 'block';
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });
    
    rtSelect.addEventListener('change', function() {
        const error = validateRT(this.value);
        if (error) {
            this.classList.add('is-invalid');
            let feedback = this.nextElementSibling;
            if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                this.parentNode.appendChild(feedback);
            }
            feedback.textContent = error;
            feedback.style.display = 'block';
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });
    
    passwordInput.addEventListener('blur', function() {
        const error = validatePassword(this.value);
        if (error) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });
    
    confirmPasswordInput.addEventListener('blur', function() {
        const error = validateConfirmPassword(passwordInput.value, this.value);
        if (error) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });
    
    // Clear validation styles on input
    usernameInput.addEventListener('input', function() {
        this.classList.remove('is-invalid', 'is-valid');
    });
    
    nomorTeleponInput.addEventListener('input', function() {
        this.classList.remove('is-invalid', 'is-valid');
    });
    
    passwordInput.addEventListener('input', function() {
        this.classList.remove('is-invalid', 'is-valid');
        confirmPasswordInput.classList.remove('is-invalid', 'is-valid');
    });
    
    confirmPasswordInput.addEventListener('input', function() {
        this.classList.remove('is-invalid', 'is-valid');
    });
    
    // Format nomor telepon
    nomorTeleponInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 0 && !value.startsWith('0')) {
            value = '0' + value;
        }
        this.value = value;
    });
});
</script>

<style>
.form-control.is-valid {
    border-color: #198754;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
}

.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3cpath d='M6 7v1'/%3e%3c/svg%3e");
}

.form-select.is-valid {
    border-color: #198754;
}

.form-select.is-invalid {
    border-color: #dc3545;
}

.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}
</style>
{% endblock %}
